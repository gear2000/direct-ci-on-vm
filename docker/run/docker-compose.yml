version: '2.0'
services:
  api:
    container_name: fastest-ci-api
    build: ./api
    restart: always
    logging:
      driver: json-file
      options:
        max-size: 50m
    env_file: .env
    volumes:
      - /var/tmp/docker/fastest-ci/queue:/var/tmp/docker/fastest-ci/queue
    command: /opt/api/bin/run.sh
  reverse_proxy:
    build: ./nginx
    logging:
      driver: json-file
      options:
        max-size: 50m
    restart: always
    links:
      - api
    ports:
      - "443:443"
  build-ci:
    container_name: build-ci
    build: ./ci
    restart: always
    logging:
      driver: json-file
      options:
        max-size: 50m
    env_file: .env
    volumes:
      - /var/tmp/docker/fastest-ci/queue:/var/tmp/docker/fastest-ci/queue
      - /var/tmp/docker/files/autogenerated/deploy.pem:/var/tmp/docker/files/autogenerated/deploy.pem
      - /var/tmp/docker/build:/var/tmp/docker/build
      - /var/run/docker.sock:/var/run/docker.sock
    command: /opt/build.py
